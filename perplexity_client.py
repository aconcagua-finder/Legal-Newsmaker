import requests
import json
import re
from datetime import datetime, timedelta
from typing import Optional, Tuple, List
from loguru import logger

import config


class PerplexityClient:
    """–ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Perplexity API (–º–æ–¥–µ–ª—å Sonar-pro)"""
    
    def __init__(self):
        self.api_key = config.PERPLEXITY_API_KEY
        self.api_url = config.PERPLEXITY_API_URL
        self.timeout = config.REQUEST_TIMEOUT
        
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
    
    def _get_yesterday_date(self) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–¥–µ–Ω—å –º–µ—Å—è—Ü'"""
        yesterday = datetime.now() - timedelta(days=1)
        months = {
            1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è",
            5: "–º–∞—è", 6: "–∏—é–Ω—è", 7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞", 
            9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
        }
        
        day = yesterday.day
        month = months[yesterday.month]
        return f"{day} {month}"
    
    def _create_prompt(self) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö"""
        yesterday_date = self._get_yesterday_date()
        
        prompt = f"""–°–ê–ú–û–ï –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –∑–∞ {yesterday_date} - –Ω–∞–π–¥–∏ –æ–¥–Ω–æ, –Ω–æ —Å–∞–º–æ–µ –≥—Ä–æ–º–∫–æ–µ!

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏–∑—É—á–∏ –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ù–∞–π–¥–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï –¥–µ—Ç–∞–ª–∏: —Å—É–º–º—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, —Å—Ä–æ–∫–∏, —à—Ç—Ä–∞—Ñ—ã, –ª—å–≥–æ—Ç—ã
- –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å "–¥–µ—Ç–∞–ª–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã", "–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞" 
- –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –º–∞–ª–æ –¥–µ—Ç–∞–ª–µ–π - –Ω–∞–π–¥–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ö–û–ù–ö–†–ï–¢–ù–´–ï –§–ê–ö–¢–´ —Å –∏—Ä–æ–Ω–∏–µ–π –∏ —é–º–æ—Ä–æ–º

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
- –ù–∞–π–¥–∏ –û–î–ù–û —Å–∞–º–æ–µ –∑–Ω–∞—á–∏–º–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–Ω–æ –∑–∞ —ç—Ç—É –¥–∞—Ç—É
- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç - –Ω–∞–ø–∏—à–∏ –∏—Ä–æ–Ω–∏—á–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± —ç—Ç–æ–º
- –ü–∏—à–∏ —Å –ª–µ–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π, –Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–∏–ª–∏—á–∏–π
- –†–∞–∑–±–µ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã (–ø–æ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–∞–∂–¥—ã–π)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

üìú –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ [1] - –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤)
(–í–ê–ñ–ù–û: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π [1] –≤ —Ç–µ–∫—Å—Ç–µ –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫!)

üí¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ö–ê–†–ú–ê–ù–ù–û–ì–û –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê:

–°—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏, –Ω–æ —Å –ª–µ–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π. –î–æ–±–∞–≤—å 1-2 –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —ç–º–æ–¥–∑–∏.

–ö–æ–≥–æ —ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å üéØ

–ö–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π üí∞ –∏–ª–∏ üòÖ

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —é–º–æ—Ä –æ —Ä–µ–∞–∫—Ü–∏–∏ –≥—Ä–∞–∂–¥–∞–Ω ü§î

–û–±—â–∏–π –∏—Ä–æ–Ω–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ –∏–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑ üîÆ

–ò–°–¢–û–ß–ù–ò–ö–ò:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–µ—Ä—ã [1], [2], [3] –≤ —Ç–µ–∫—Å—Ç–µ —Ç–∞–º, –≥–¥–µ —Å—Å—ã–ª–∞–µ—à—å—Å—è –Ω–∞ —Ñ–∞–∫—Ç—ã
- –ù–∞–ø—Ä–∏–º–µ—Ä: "–° 1 –∏—é–Ω—è –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É –∑–∞–∫–æ–Ω [1]", "—à—Ç—Ä–∞—Ñ —Å–æ—Å—Ç–∞–≤–∏—Ç 5000 —Ä—É–±–ª–µ–π [2]"
- –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å —Å–µ–∫—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

–ò–°–¢–û–ß–ù–ò–ö–ò:
üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://sozd.duma.gov.ru/bill/–Ω–æ–º–µ—Ä-–∑–∞–∫–æ–Ω–æ–ø—Ä–æ–µ–∫—Ç–∞
üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://pravo.gov.ru/proxy/ips/?docbody=–Ω–æ–º–µ—Ä-–¥–æ–∫—É–º–µ–Ω—Ç–∞
üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://regulation.gov.ru/projects/–Ω–æ–º–µ—Ä-–ø—Ä–æ–µ–∫—Ç–∞

–í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏!

–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ —Å –ª–µ–≥–∫–æ–π –∏—Ä–æ–Ω–∏–µ–π, –Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."""

        return prompt
    
    def _extract_sources_from_content(self, content: str) -> Tuple[str, List[str]]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –Ω–æ–º–µ—Ä–∞–º–∏ + —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫
        
        Args:
            content: –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI
            
        Returns:
            Tuple[str, List[str]]: (—Ç–µ–∫—Å—Ç —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É)
        """
        sources = []
        
        # –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∏ —Å–µ–∫—Ü–∏—é —Å—Å—ã–ª–æ–∫
        lines = content.split('\n')
        main_content_lines = []
        sources_section_started = False
        
        for line in lines:
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É "–ò–°–¢–û–ß–ù–ò–ö–ò:" –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å–µ–∫—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            if line.strip().upper() == '–ò–°–¢–û–ß–ù–ò–ö–ò:' or line.strip().upper().startswith('–ò–°–¢–û–ß–ù–ò–ö'):
                sources_section_started = True
                # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                continue
                
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: "üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://...")
            if line.strip().startswith('üîó'):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Å—ã–ª–∫—É –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∏–ø–∞ "üîó –ò—Å—Ç–æ—á–Ω–∏–∫: https://—Å—Å—ã–ª–∫–∞ [1]"
                url_match = re.search(r'https?://[^\s\[\]]+', line)
                if url_match:
                    source_url = url_match.group().rstrip('.,;:')
                    sources.append(source_url)
                # –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - —É–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                continue
                
            # –¢–∞–∫–∂–µ –∏—â–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–µ–∫—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            if re.match(r'^–°—Å—ã–ª–∫–∏:\s*$', line.strip(), re.IGNORECASE):
                sources_section_started = True
                continue
            
            if sources_section_started:
                # –í —Å–µ–∫—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –∏—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ [–Ω–æ–º–µ—Ä] —Å—Å—ã–ª–∫–∞
                source_match = re.match(r'^\[(\d+)\]\s*(https?://[^\s]+)', line.strip())
                if source_match:
                    source_num = int(source_match.group(1))
                    source_url = source_match.group(2).rstrip('.,;:')
                    
                    # –†–∞—Å—à–∏—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    while len(sources) < source_num:
                        sources.append('')
                    sources[source_num - 1] = source_url
            else:
                # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                main_content_lines.append(line)
        
        # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ sources
        sources = [s for s in sources if s]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
        main_content = '\n'.join(main_content_lines).strip()
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤ —Ç–µ–∫—Å—Ç–µ
        if not sources:
            url_pattern = r'https?://[^\s\)\]>]+'
            sources = re.findall(url_pattern, content)
            sources = list(set(sources))
            sources = [source.rstrip('.,;:') for source in sources]
            
            # –ï—Å–ª–∏ URL –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            if not sources and '[1]' in main_content:
                # –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞–∫–æ–Ω–æ–ø—Ä–æ–µ–∫—Ç–æ–≤
                bill_match = re.search(r'N\s*(\d+-\d+)', main_content)
                if bill_match:
                    bill_number = bill_match.group(1)
                    sources.append(f'https://sozd.duma.gov.ru/bill/{bill_number}')
                else:
                    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    sources.append('https://sozd.duma.gov.ru/')
                    
                logger.warning("–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –æ—Ç–≤–µ—Ç–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏")
        
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(sources)} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
        if sources:
            for i, source in enumerate(sources, 1):
                logger.debug(f"–ò—Å—Ç–æ—á–Ω–∏–∫ [{i}]: {source}")
        
        return main_content, sources
    
    def get_legal_updates(self) -> Optional[dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å
        
        Returns:
            dict: {'content': str, 'sources': List[str]} –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        """
        try:
            prompt = self._create_prompt()
            yesterday_date = self._get_yesterday_date()
            
            logger.info(f"–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∑–∞ {yesterday_date}")
            
            payload = {
                "model": "sonar-pro",
                "messages": [
                    {
                        "role": "system",
                        "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É. –û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ."
                    },
                    {
                        "role": "user", 
                        "content": prompt
                    }
                ],
                "max_tokens": 1000,
                "temperature": 0.2,
                "top_p": 0.9
            }
            
            response = requests.post(
                self.api_url,
                headers=self.headers,
                json=payload,
                timeout=self.timeout
            )
            
            response.raise_for_status()
            
            data = response.json()
            raw_content = data['choices'][0]['message']['content']
            
            logger.info("–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Perplexity API")
            logger.debug(f"–û—Ç–≤–µ—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {raw_content[:500]}...")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ —Å—Å—ã–ª–æ–∫
            link_markers = re.findall(r'\[\d+\]', raw_content)
            if link_markers:
                logger.debug(f"–ù–∞–π–¥–µ–Ω—ã –º–∞—Ä–∫–µ—Ä—ã —Å—Å—ã–ª–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ: {link_markers}")
            else:
                logger.warning("–í —Ç–µ–∫—Å—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –º–∞—Ä–∫–µ—Ä—ã —Å—Å—ã–ª–æ–∫ [1], [2] –∏ —Ç.–¥.")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
            content, sources = self._extract_sources_from_content(raw_content)
            
            return {
                'content': content,
                'sources': sources
            }
            
        except requests.exceptions.RequestException as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Perplexity API: {e}")
            return None
            
        except KeyError as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API: {e}")
            return None
            
        except Exception as e:
            logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å API: {e}")
            return None
    
    def test_connection(self) -> bool:
        """
        –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
        
        Returns:
            bool: True –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        """
        try:
            test_payload = {
                "model": "sonar-pro",
                "messages": [
                    {
                        "role": "user",
                        "content": "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
                    }
                ],
                "max_tokens": 50
            }
            
            response = requests.post(
                self.api_url,
                headers=self.headers,
                json=test_payload,
                timeout=10
            )
            
            response.raise_for_status()
            logger.info("–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Perplexity API –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ")
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
            return False 